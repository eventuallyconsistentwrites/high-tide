version: '3.8'

services:
  high-tide-server:
    # ... (Keep your server config exactly as it is) ...
    build:
      context: ../high-tide-server
      dockerfile: Dockerfile
    ports:
      - "8081:${SERVER_PORT:-8080}"
    environment:
      - LISTEN_ADDR=:${SERVER_PORT:-8080}
      - DB_PATH=/app/data/high_tide.db
      - RESET_INTERVAL=120
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:${SERVER_PORT:-8080}/healthz"]
      interval: 10s
      timeout: 5s
      retries: 5
    volumes:
      - ../high-tide-server/data:/app/data

  # This replaces the 'tester' service
  k6-worker:
    image: grafana/k6:latest
    depends_on:
      high-tide-server:
        condition: service_healthy
    volumes:
      # Mount the local script so the container can see it
      - ./loadtest.js:/script.js
    environment:
      - SERVER_HOST=high-tide-server
      - SERVER_PORT=${SERVER_PORT:-8080}
      - K6_VUS=${K6_VUS:-10}           # Default to 10 if not set
      - K6_DURATION=${K6_DURATION:-30s} # Default to 30s if not set
    # Run the script with 100 users per container
    command: run /script.js